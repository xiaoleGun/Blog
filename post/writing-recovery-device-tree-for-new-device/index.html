<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>为新设备编写Recovery device tree - xiaoleGun&#039;Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="xiaoleGun"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="xiaoleGun"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="这篇教程中可能有些不对的地方，请各位指正。"><meta property="og:type" content="blog"><meta property="og:title" content="为新设备编写Recovery device tree"><meta property="og:url" content="https://blog.xiaolegun.cn/post/writing-recovery-device-tree-for-new-device/"><meta property="og:site_name" content="xiaoleGun&#039;Blog"><meta property="og:description" content="这篇教程中可能有些不对的地方，请各位指正。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.xiaolegun.cn/img/og_image.png"><meta property="article:published_time" content="2024-02-20T02:46:55.000Z"><meta property="article:modified_time" content="2024-02-20T03:01:52.000Z"><meta property="article:author" content="xiaoleGun"><meta property="article:tag" content="Android"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blog.xiaolegun.cn/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.xiaolegun.cn/post/writing-recovery-device-tree-for-new-device/"},"headline":"为新设备编写Recovery device tree","image":["https://blog.xiaolegun.cn/img/og_image.png"],"datePublished":"2024-02-20T02:46:55.000Z","dateModified":"2024-02-20T03:01:52.000Z","author":{"@type":"Person","name":"xiaoleGun"},"publisher":{"@type":"Organization","name":"xiaoleGun'Blog","logo":{"@type":"ImageObject","url":"https://blog.xiaolegun.cn/img/touxiang.png"}},"description":"这篇教程中可能有些不对的地方，请各位指正。"}</script><link rel="canonical" href="https://blog.xiaolegun.cn/post/writing-recovery-device-tree-for-new-device/"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/touxiang.png" alt="xiaoleGun&#039;Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-02-20T02:46:55.000Z" title="2024/2/20 10:46:55">2024-02-20</time>发表</span><span class="level-item"><time dateTime="2024-02-20T03:01:52.000Z" title="2024/2/20 11:01:52">2024-02-20</time>更新</span><span class="level-item">1 小时读完 (大约10958个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">为新设备编写Recovery device tree</h1><div class="content"><h2 id="一些自序"><a href="#一些自序" class="headerlink" title="一些自序"></a>一些自序</h2><p>这篇教程中可能有些不对的地方，请各位指正，我也刚接触 Android 设备测开发两年，而且只有在节假日的时候有空一个人瞎捣鼓，为了<del>薅 mjw 羊毛</del>，故写这篇教程，而且我个人更推荐 Aosp Recovery 刷写第三方 ROM，TWRP 可能多多少少有些问题。Root 之类的不需要 TWRP 也可以，可以找到原机 boot 使用 Magisk 进行修补，也可以使用 KernelSU。另外我的语文功底不是很好，写不出辞藻，只能是北方地道的大白话，见谅哈 🤣&#x2F;&#x2F;&#x2F;</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>1.一颗勇敢的、不怕困难的强大心脏。<br><strong><del>两颗心好勇敢 – Falling in love</del></strong> </p>
<p>2.电脑配置:</p>
<table>
<thead>
<tr>
<th>硬件</th>
<th>需求</th>
</tr>
</thead>
<tbody><tr>
<td>CPU</td>
<td>四核或更多</td>
</tr>
<tr>
<td>内存</td>
<td>8G 或更多</td>
</tr>
<tr>
<td>硬盘</td>
<td>至少 80G 空余空间</td>
</tr>
<tr>
<td>系统</td>
<td>WSL 或实体 Linux，建议 Debian 系</td>
</tr>
</tbody></table>
<p>3.足够的空闲时间。</p>
<p>4.Vscode 和 🤏Linux 知识储备 </p>
<p>5.一台完好无损的新设备。 </p>
<p>6.设备原厂的 boot&#x2F;recovery&#x2F;vendor_boot 镜像。(推荐 recovery 分区，因为里面包含一些启动必须的.rc(run command)，如果没有该分区，寻找包含官方 recovery 内容的分区。值得注意的是部分设备 recovery 合并到了 boot 中，或是存在于 vendor_boot） </p>
<p>7.查看自己的设备出厂 Android 版本并确定用途，是用于官方 ROM 还是第三方类原生。出厂版本为 9 及以上的可以使用 twrp-11 及以上分支，9 以下使用 twrp-9 分支。</p>
<h2 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt-get install bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev xattr openjdk-11-jdk jq android-sdk-libsparse-utils python3 python2 repo</span><br></pre></td></tr></table></figure>

<p>必要时可以阅读<a target="_blank" rel="noopener" href="https://source.android.com/source/using-repo?hl=zh-cn">Git 和 Repo</a></p>
<h3 id="配置-Git-和-Repo"><a href="#配置-Git-和-Repo" class="headerlink" title="配置 Git 和 Repo"></a>配置 Git 和 Repo</h3><p>安装完依赖后，在终端执行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name &quot;your username&quot;</span><br><span class="line">git config --global user.email &quot;your email&quot;</span><br></pre></td></tr></table></figure>

<h3 id="同步-TWRP-源码"><a href="#同步-TWRP-源码" class="headerlink" title="同步 TWRP 源码"></a>同步 TWRP 源码</h3><p>在自己方便的地方，建立一个目录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir twrp</span><br><span class="line">cd twrp</span><br></pre></td></tr></table></figure>

<p>根据自己在准备工作中确定的分支同步相应的源码。</p>
<h4 id="TWRP-9"><a href="#TWRP-9" class="headerlink" title="TWRP-9"></a>TWRP-9</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni.git -b twrp-9.0</span><br><span class="line">repo sync</span><br></pre></td></tr></table></figure>

<h4 id="TWRP-11"><a href="#TWRP-11" class="headerlink" title="TWRP-11"></a>TWRP-11</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-11</span><br><span class="line">repo sync</span><br></pre></td></tr></table></figure>

<h4 id="TWRP-12-1"><a href="#TWRP-12-1" class="headerlink" title="TWRP-12.1"></a>TWRP-12.1</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-12.1</span><br><span class="line">repo sync</span><br></pre></td></tr></table></figure>

<h2 id="编写设备树"><a href="#编写设备树" class="headerlink" title="编写设备树"></a>编写设备树</h2><blockquote>
<p>最基本的开机部分我通过 Redmi K50 做示例，并选取 TWRP-12.1 分支。</p>
</blockquote>
<blockquote>
<p>解密部分会单独成一个章节并分为高通和联发科。</p>
</blockquote>
<h3 id="获取资料"><a href="#获取资料" class="headerlink" title="获取资料"></a>获取资料</h3><p>小米设备一般可以在<a target="_blank" rel="noopener" href="https://xiaomirom.com/">Xiaomirom</a>中的线刷包获取 boot&#x2F;recovery&#x2F;vendor_boot 镜像，其它设备请自行寻找。</p>
<h4 id="安装工具和依赖"><a href="#安装工具和依赖" class="headerlink" title="安装工具和依赖"></a>安装工具和依赖</h4><p>将准备工作中准备的 boot&#x2F;recovery&#x2F;vendor_boot 镜像解包，可以用任何工具，我这里使用<a target="_blank" rel="noopener" href="https://github.com/cfig/Android_boot_image_editor">Android_boot_image_editor</a>按照自述文件进行依赖安装操作：</p>
<h5 id="Mac-Intel"><a href="#Mac-Intel" class="headerlink" title="Mac(Intel)"></a>Mac(Intel)</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install lz4 xz dtc openjdk@17</span><br><span class="line">echo &#x27;export PATH=&quot;/usr/local/opt/openjdk@17/bin:$PATH&quot;&#x27; &gt;&gt; ~/.zshrc</span><br><span class="line">source ~/.zshrc</span><br></pre></td></tr></table></figure>

<h5 id="Linux"><a href="#Linux" class="headerlink" title="Linux:"></a>Linux:</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install git device-tree-compiler lz4 xz-utils zlib1g-dev openjdk-17-jdk gcc g++ python3 python-is-python3 p7zip-full android-sdk-libsparse-utils erofs-utils</span><br></pre></td></tr></table></figure>

<h5 id="Common"><a href="#Common" class="headerlink" title="Common:"></a>Common:</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/cfig/Android_boot_image_editor</span><br><span class="line">cd Android_boot_image_editor</span><br></pre></td></tr></table></figure>

<h4 id="解包"><a href="#解包" class="headerlink" title="解包"></a>解包</h4><blockquote>
<p>请注意”&#x2F;“表示或的意思，请不要误以为是一个东西。</p>
</blockquote>
<blockquote>
<p>如果不确定分区寻找的是否正确，请尝试将可以的分区进行解包，并查看其<code>ramdisk</code>内是否包含<code>recovery</code>字样的文件</p>
</blockquote>
<p>将你准备好的<code>boot</code>&#x2F;<code>recovery</code>&#x2F;<code>vendor_boot</code>复制到该目录，你可以使用 GUI 或者 CLI。如:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp &lt;出厂boot/recovery/vendor_boot的绝对路径&gt; boot/recovery/vendor_boot.img</span><br><span class="line">./gradlew unpack</span><br></pre></td></tr></table></figure>

<p>我这里以 Redmi K50 为例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">10:12:13.188 [main] INFO  cfig.bootimg.v3.VendorBoot -</span><br><span class="line">                        Unpack Summary of vendor_boot.img</span><br><span class="line">┌───────────────────────────────────────┬──────────────────────────────────────┐</span><br><span class="line">│What                                   │Where                                 │</span><br><span class="line">└───────────────────────────────────────┴──────────────────────────────────────┘</span><br><span class="line">┌───────────────────────────────────────┬──────────────────────────────────────┐</span><br><span class="line">│image info                             │build/unzip_boot/vendor_boot.json     │</span><br><span class="line">├───────────────────────────────────────┼──────────────────────────────────────┤</span><br><span class="line">│ramdisk                                │build/unzip_boot/ramdisk.img.lz4      │</span><br><span class="line">│-- PLATFORM ramdisk[1/1]               │build/unzip_boot/ramdisk.1.lz4        │</span><br><span class="line">│------- extracted rootfs               │build/unzip_boot/root.1               │</span><br><span class="line">├───────────────────────────────────────┼──────────────────────────────────────┤</span><br><span class="line">│dtb                                    │build/unzip_boot/dtb                  │</span><br><span class="line">├───────────────────────────────────────┼──────────────────────────────────────┤</span><br><span class="line">│AVB info                               │build/unzip_boot/vendor_boot.avb.json │</span><br><span class="line">│\-- signing key                        │NONE                                  │</span><br><span class="line">└───────────────────────────────────────┴──────────────────────────────────────┘</span><br><span class="line">10:12:13.213 [main] WARN  cfig.packable.PackableLauncher - &#x27;unpack&#x27; sequence completed</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL in 2s</span><br></pre></td></tr></table></figure>

<p>解包成功后终端会打印出以上信息，其中包含<code>vendor_boot</code>目录结构，我们只需要<code>ramdisk</code>里的部分内容就好了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls build/unzip_boot/root.1 # 请根据自己的分区和设备判断ramdisk的命名，一般都直接是ramdisk</span><br></pre></td></tr></table></figure>

<p>不出意外的话会输出以下内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/dump/bootedit   master ?  ls build/unzip_boot/root.1</span><br><span class="line">acct                         oem</span><br><span class="line">apex                         plat_file_contexts</span><br><span class="line">bin                          plat_property_contexts</span><br><span class="line">bugreports                   postinstall</span><br><span class="line">config                       proc</span><br><span class="line">d                            product</span><br><span class="line">data                         product_file_contexts</span><br><span class="line">data_mirror                  product_property_contexts</span><br><span class="line">debug_ramdisk                prop.default</span><br><span class="line">default.prop                 res</span><br><span class="line">dev                          sdcard</span><br><span class="line">etc                          second_stage_resources</span><br><span class="line">first_stage_ramdisk          sepolicy</span><br><span class="line">init                         storage</span><br><span class="line">init.recovery.hardware.rc    sys</span><br><span class="line">init.recovery.mt6895.rc      system</span><br><span class="line">lib                          system_ext</span><br><span class="line">linkerconfig                 system_ext_file_contexts</span><br><span class="line">miui.factoryreset.fstab      system_ext_property_contexts</span><br><span class="line">miui.factoryreset.rc         tmp</span><br><span class="line">mnt                          vendor</span><br><span class="line">odm                          vendor_dlkm</span><br><span class="line">odm_dlkm                     vendor_file_contexts</span><br><span class="line">odm_file_contexts            vendor_property_contexts</span><br><span class="line">odm_property_contexts</span><br></pre></td></tr></table></figure>

<p>如果包含 init.recovery*的字样，恭喜你成功找到了正确的分区。将这个目录复制到一个自己方便的地方。<br>至此资料已经大致齐全了，解密的资料会在解密章节来讲解如何获取。</p>
<h3 id="初始化目录结构"><a href="#初始化目录结构" class="headerlink" title="初始化目录结构"></a>初始化目录结构</h3><p>在 twrp 源码根目录输入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p device/vendor/codename</span><br><span class="line">mkdir -p device/vendor/codename/recovery/root</span><br><span class="line">cd device/vendor/codename</span><br></pre></td></tr></table></figure>

<p><code>vendor</code>指的是供应商，如 xiaomi、oneplus、huawei、vivo、realme。<br><code>codename</code>指的是设备代号，小米设备可以在<a target="_blank" rel="noopener" href="https://xiaomirom.com/">Xiaomirom</a>查询，其它设备自行查询亦或是在开发者选项勾选 USB 调试通过 adb 尝试获取。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb shell getprop ro.product.manufacturer # 供应商</span><br><span class="line">adb shell getprop ro.product.device # 设备代号</span><br></pre></td></tr></table></figure>

<p>我的 Redmi K50 会打印以下信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/dump/bootedit   master ?  adb shell getprop ro.product.manufacturer</span><br><span class="line">Xiaomi # 无论打印出来的内容是大写还是小写，在目录结构中我们都采用小写</span><br><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/dump/bootedit   master ?  adb shell getprop ro.product.device</span><br><span class="line">rubens</span><br></pre></td></tr></table></figure>

<p>我的 IQOO NEO5 Lite 会打印以下信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/tmp/device/xiaomi/rubens  adb shell getprop ro.product.manufacturer</span><br><span class="line">vivo</span><br><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/tmp/device/xiaomi/rubens  adb shell getprop ro.product.device</span><br><span class="line">PD2118</span><br></pre></td></tr></table></figure>

<p>一般只要不是山寨机，小作坊出来的机子，用这两条命令应该是可以正确获取的。</p>
<h3 id="初始化构建时必要的文件"><a href="#初始化构建时必要的文件" class="headerlink" title="初始化构建时必要的文件"></a>初始化构建时必要的文件</h3><p>无论是 AOSP device tree 亦或是 TWRP device tree 都基本类似于以下结构。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/</span><br><span class="line">├── prebuilt           (存放kernel、dtb等预编译文件) # AOSP device tree若使用build kernel则没有该目录</span><br><span class="line">├── recovery/root      (存放一些.rc和解密blobs) # 一般用于Recovery device tree</span><br><span class="line">├── Android.mk         (Android构建系统首先会检查每个目录的Android.mk，里面包含一些判断，由它包括其所在目录中所有Makefile)</span><br><span class="line">├── AndroidProducts.mk (声明产品的Makefile和lunch时可用的构建类型)</span><br><span class="line">├── BoardConfig.mk     (板载配置文件，定义了主板必要的Flag)</span><br><span class="line">├── device.mk          (声明设备所需的文件和模块)</span><br><span class="line">└── &lt;ROM&gt;_codename.mk  (声明产品特定信息，例如名称、品牌和型号，引用device.mk等) # ROM就比如lineage、arrow等，编译twrp就直接写twrp，twrp-9分支要写onmi</span><br></pre></td></tr></table></figure>

<p>我们把这样的结构称为骨架树(skeleton tree)。<br>接下来我们按照以上结构为自己的设备写一份 Recovery device tree。<br>在终端使用<code>touch</code>命令创建必要的文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch Android.mk AndroidProducts.mk BoardConfig.mk device.mk twrp_rubens.mk</span><br><span class="line">ls .</span><br></pre></td></tr></table></figure>

<p>不出意外的话会打印出以下信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/tmp/device/xiaomi/rubens  touch Android.mk AndroidProducts.mk BoardConfig.mk device.mk twrp_rubens.mk</span><br><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/tmp/device/xiaomi/rubens  ls .</span><br><span class="line">Android.mk         BoardConfig.mk     prebuilt           twrp_rubens.mk</span><br><span class="line">AndroidProducts.mk device.mk          recovery</span><br></pre></td></tr></table></figure>

<p>可以下一步了~</p>
<h4 id="初始-Android-mk-文件"><a href="#初始-Android-mk-文件" class="headerlink" title="初始 Android.mk 文件"></a>初始 Android.mk 文件</h4><p>打开 Vscode 并打开设备树目录，你足够强也可以使用 nano、vim 编辑。<br>选中 Android.mk 并按照自己的资料复制并更改以下内容</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(TARGET_DEVICE)</span>,codename)</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(<span class="built_in">call</span> all-subdir-makefiles,<span class="variable">$(LOCAL_PATH)</span>)</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>codename</code>是需要你修改的部分</li>
</ul>
<p>我修改后是这样的</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(TARGET_DEVICE)</span>,rubens)</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(<span class="built_in">call</span> all-subdir-makefiles,<span class="variable">$(LOCAL_PATH)</span>)</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="初始-AndroidProducts-mk-文件"><a href="#初始-AndroidProducts-mk-文件" class="headerlink" title="初始 AndroidProducts.mk 文件"></a>初始 AndroidProducts.mk 文件</h4><p>选中 AndroidProducts.mk 并按照自己的资料复制并更改以下内容</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_MAKEFILES := \</span><br><span class="line">    <span class="variable">$(LOCAL_DIR)</span>/&lt;ROM&gt;_&lt;codename&gt;.mk</span><br><span class="line"></span><br><span class="line">COMMON_LUNCH_CHOICES := \</span><br><span class="line">    &lt;ROM&gt;_&lt;codename&gt;-eng</span><br></pre></td></tr></table></figure>

<p>我修改后是这样的</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_MAKEFILES := \</span><br><span class="line">    <span class="variable">$(LOCAL_DIR)</span>/twrp_rubens.mk</span><br><span class="line"></span><br><span class="line">COMMON_LUNCH_CHOICES := \</span><br><span class="line">    twrp_rubens-eng</span><br></pre></td></tr></table></figure>

<h4 id="初始-BoardConfig-mk-文件"><a href="#初始-BoardConfig-mk-文件" class="headerlink" title="初始 BoardConfig.mk 文件"></a>初始 BoardConfig.mk 文件</h4><blockquote>
<p>将之前准备的<code>ramdisk</code>文件夹用新窗口打开 1.找到目录下的 prop.default 或含 prop 字样的文件。以下注释类似 ro.*.*的就是从 prop 中获取的 2.解包 boot&#x2F;recovery&#x2F;vendor_boot 的 json<br>例如 build&#x2F;unzip_boot&#x2F;boot.json</p>
</blockquote>
<p>选中 BoardConfig.mk 并按照自己的资料复制并更改以下内容</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">DEVICE_PATH := device/vendor/codename</span><br><span class="line"></span><br><span class="line"><span class="comment"># Architecture</span></span><br><span class="line">TARGET_ARCH := arm64 <span class="comment"># ro.bionic.arch</span></span><br><span class="line">TARGET_ARCH_VARIANT := armv8-a <span class="comment"># 64位默认变体</span></span><br><span class="line">TARGET_CPU_ABI := arm64-v8a <span class="comment"># ro.vendor.product.cpu.abilist64 (至少在小米设备上没有找到ro.product.cpu.abilist)</span></span><br><span class="line">TARGET_CPU_ABI2 := <span class="comment"># 64位留空</span></span><br><span class="line">TARGET_CPU_VARIANT := generic <span class="comment"># 默认一般都是通用</span></span><br><span class="line">TARGET_CPU_VARIANT_RUNTIME := cortex-a55 <span class="comment"># ro.bionic.cpu_variant</span></span><br><span class="line"></span><br><span class="line">TARGET_2ND_ARCH := arm <span class="comment"># ro.bionic.2nd_arch</span></span><br><span class="line">TARGET_2ND_ARCH_VARIANT := <span class="variable">$(TARGET_ARCH_VARIANT)</span></span><br><span class="line">TARGET_2ND_CPU_ABI := armeabi-v7a <span class="comment"># ro.vendor.product.cpu.abilist32第一个</span></span><br><span class="line">TARGET_2ND_CPU_ABI2 := armeabi <span class="comment"># ro.vendor.product.cpu.abilist32第二个</span></span><br><span class="line">TARGET_2ND_CPU_VARIANT := <span class="variable">$(TARGET_CPU_VARIANT)</span></span><br><span class="line">TARGET_2ND_CPU_VARIANT_RUNTIME := <span class="variable">$(TARGET_CPU_VARIANT)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Assertation</span></span><br><span class="line">TARGET_OTA_ASSERT_DEVICE := rubens <span class="comment"># codename</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bootloader</span></span><br><span class="line">TARGET_BOOTLOADER_BOARD_NAME := rubens <span class="comment"># ro.product.board</span></span><br><span class="line">TARGET_NO_BOOTLOADER := true</span><br><span class="line">TARGET_USES_UEFI := true</span><br><span class="line"></span><br><span class="line"><span class="comment"># Build Rule</span></span><br><span class="line">ALLOW_MISSING_DEPENDENCIES := true <span class="comment"># 为了recovery不健全的依赖</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Kernel - 注释会说明在boot/recovery/vendor_boot.json中对应的变量</span></span><br><span class="line">BOARD_BOOTIMG_HEADER_VERSION := 4 <span class="comment"># headerVersion</span></span><br><span class="line">BOARD_KERNEL_BASE := 0x3fff8000 <span class="comment"># (kernelLoadAddr - 32KB) qcom设备base为0，且没有偏移(offset)</span></span><br><span class="line">BOARD_KERNEL_CMDLINE := bootopt=64S3,32N2,64N2 <span class="comment"># cmdline</span></span><br><span class="line">BOARD_KERNEL_PAGESIZE := 4096 <span class="comment"># pageSize</span></span><br><span class="line">BOARD_RAMDISK_OFFSET := 0x26f08000 <span class="comment"># (ramdisk,loadAddr - BOARD_KERNEL_BASE)</span></span><br><span class="line">BOARD_KERNEL_TAGS_OFFSET := 0x07c88000 <span class="comment"># (tagsLoadAddr - BOARD_KERNEL_BASE)</span></span><br><span class="line">BOARD_MKBOOTIMG_ARGS += --header_version <span class="variable">$(BOARD_BOOTIMG_HEADER_VERSION)</span></span><br><span class="line">BOARD_MKBOOTIMG_ARGS += --ramdisk_offset <span class="variable">$(BOARD_RAMDISK_OFFSET)</span></span><br><span class="line">BOARD_MKBOOTIMG_ARGS += --tags_offset <span class="variable">$(BOARD_KERNEL_TAGS_OFFSET)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Kernel - prebuilt</span></span><br><span class="line">TARGET_PREBUILT_KERNEL := <span class="variable">$(DEVICE_PATH)</span>/prebuilt/kernel <span class="comment"># 预编译内核相对于android源码根目录的相对路径，vendor_boot机型不需要</span></span><br><span class="line">TARGET_PREBUILT_DTB := <span class="variable">$(DEVICE_PATH)</span>/prebuilt/dtb.img <span class="comment"># 同上</span></span><br><span class="line">BOARD_MKBOOTIMG_ARGS += --dtb <span class="variable">$(TARGET_PREBUILT_DTB)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Partitions</span></span><br><span class="line">BOARD_FLASH_BLOCK_SIZE := 262144 <span class="comment"># (BOARD_KERNEL_PAGESIZE * 64)</span></span><br><span class="line">BOARD_BOOTIMAGE_PARTITION_SIZE := 67108864 <span class="comment"># boot/recovery/vendor_boot镜像的字节大小需原厂或手机完整提取出来的，不定义会报错</span></span><br><span class="line">BOARD_RECOVERYIMAGE_PARTITION_SIZE := 67108864 <span class="comment"># 同上</span></span><br><span class="line">BOARD_VENDOR_ROOTIMAGE_PARTITION_SIZE := 67108864 <span class="comment"># 同上</span></span><br><span class="line">BOARD_SYSTEMIMAGE_PARTITION_TYPE := ext4 <span class="comment"># 分区类型，查看ramdisk中fstab定义的类型</span></span><br><span class="line">BOARD_USERDATAIMAGE_FILE_SYSTEM_TYPE := ext4</span><br><span class="line">BOARD_VENDORIMAGE_FILE_SYSTEM_TYPE := ext4</span><br><span class="line">TARGET_COPY_OUT_VENDOR := vendor <span class="comment"># 定义vendor目录，例如copy专有blobs要用</span></span><br><span class="line">BOARD_SUPER_PARTITION_SIZE := 9126805504 <span class="comment"># 可以通过blockdev --getsize64 /dev/block/bootdevice/by-name/super获取，需root，如果无法root可以直接使用这个值，不影响twrp启动，可以后续修正</span></span><br><span class="line">BOARD_SUPER_PARTITION_GROUPS := xiaomi_dynamic_partitions <span class="comment"># xiaomi根据你获取资料的vendor替换，是一个动态分区组</span></span><br><span class="line">BOARD_XIAOMI_DYNAMIC_PARTITIONS_PARTITION_LIST := system vendor product system_ext odm vendor_dlkm odm_dlkm <span class="comment"># 根据fstab内的定义，一般flag包含logical都属于动态分区组的一部分</span></span><br><span class="line">BOARD_XIAOMI_DYNAMIC_PARTITIONS_SIZE := 9122611200 <span class="comment"># (BOARD_SUPER_PARTITION_SIZE - 4MB)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Platform</span></span><br><span class="line">TARGET_BOARD_PLATFORM := mt6895 <span class="comment"># ro.board.platform</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Recovery - 基本通用的不影响启动</span></span><br><span class="line">BOARD_HAS_LARGE_FILESYSTEM := true</span><br><span class="line">TARGET_RECOVERY_PIXEL_FORMAT := RGBX_8888</span><br><span class="line">TARGET_USERIMAGES_USE_EXT4 := true</span><br><span class="line">TARGET_USERIMAGES_USE_F2FS := true</span><br><span class="line"></span><br><span class="line"><span class="comment"># Treble</span></span><br><span class="line">BOARD_VNDK_VERSION := current <span class="comment"># 声明VNDK版本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Vendor_boot recovery ramdisk</span></span><br><span class="line">BOARD_MOVE_RECOVERY_RESOURCES_TO_VENDOR_BOOT := true <span class="comment"># 将recovery文件复制到vendor_boot</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Boot recovery ramdisk</span></span><br><span class="line"><span class="comment">#BOARD_USES_RECOVERY_AS_BOOT := true recovery ramdisk合并在boot中启用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Verified Boot</span></span><br><span class="line">BOARD_AVB_ENABLE := true</span><br><span class="line">BOARD_AVB_MAKE_VBMETA_IMAGE_ARGS += --flags 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># TWRP Configurations</span></span><br><span class="line">TW_DEFAULT_LANGUAGE := zh_CN <span class="comment"># 默认为中文</span></span><br><span class="line">TW_EXTRA_LANGUAGES := true <span class="comment"># 额外的语言</span></span><br><span class="line">TW_THEME := portrait_hdpi <span class="comment"># 主题</span></span><br><span class="line">TW_INCLUDE_FASTBOOTD := true <span class="comment"># 包括fastbootd，为动态分区</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其它flag还有很多，可以在https://xdaforums.com/t/twrp-flags-for-boardconfig-mk.3333970 查找，</span></span><br><span class="line"><span class="comment"># 这篇文章也很老了，但我并不推荐twrp，所以flag我也不是很了解，多翻翻github:)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Debug</span></span><br><span class="line">TARGET_USES_LOGD := true <span class="comment"># 调试flag</span></span><br><span class="line">TWRP_INCLUDE_LOGCAT := true</span><br></pre></td></tr></table></figure>

<p>无注释版</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">DEVICE_PATH := device/vendor/codename</span><br><span class="line"></span><br><span class="line"><span class="comment"># Architecture</span></span><br><span class="line">TARGET_ARCH := arm64</span><br><span class="line">TARGET_ARCH_VARIANT := armv8-a</span><br><span class="line">TARGET_CPU_ABI := arm64-v8a</span><br><span class="line">TARGET_CPU_ABI2 :=</span><br><span class="line">TARGET_CPU_VARIANT := generic</span><br><span class="line">TARGET_CPU_VARIANT_RUNTIME := cortex-a55</span><br><span class="line"></span><br><span class="line">TARGET_2ND_ARCH := arm</span><br><span class="line">TARGET_2ND_ARCH_VARIANT := <span class="variable">$(TARGET_ARCH_VARIANT)</span></span><br><span class="line">TARGET_2ND_CPU_ABI := armeabi-v7a</span><br><span class="line">TARGET_2ND_CPU_ABI2 := armeabi</span><br><span class="line">TARGET_2ND_CPU_VARIANT := <span class="variable">$(TARGET_CPU_VARIANT)</span></span><br><span class="line">TARGET_2ND_CPU_VARIANT_RUNTIME := <span class="variable">$(TARGET_CPU_VARIANT)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Assertation</span></span><br><span class="line">TARGET_OTA_ASSERT_DEVICE := rubens</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bootloader</span></span><br><span class="line">TARGET_BOOTLOADER_BOARD_NAME := rubens</span><br><span class="line">TARGET_NO_BOOTLOADER := true</span><br><span class="line">TARGET_USES_UEFI := true</span><br><span class="line"></span><br><span class="line"><span class="comment"># Build Rule</span></span><br><span class="line">ALLOW_MISSING_DEPENDENCIES := true</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kernel</span></span><br><span class="line">BOARD_BOOT_HEADER_VERSION := 4</span><br><span class="line">BOARD_KERNEL_BASE := 0x3fff8000</span><br><span class="line">BOARD_KERNEL_CMDLINE := bootopt=64S3,32N2,64N2</span><br><span class="line">BOARD_KERNEL_PAGESIZE := 4096</span><br><span class="line">BOARD_RAMDISK_OFFSET := 0x26f08000</span><br><span class="line">BOARD_KERNEL_TAGS_OFFSET := 0x07c88000</span><br><span class="line">BOARD_MKBOOTIMG_ARGS += --header_version <span class="variable">$(BOARD_BOOT_HEADER_VERSION)</span></span><br><span class="line">BOARD_MKBOOTIMG_ARGS += --ramdisk_offset <span class="variable">$(BOARD_RAMDISK_OFFSET)</span></span><br><span class="line">BOARD_MKBOOTIMG_ARGS += --tags_offset <span class="variable">$(BOARD_KERNEL_TAGS_OFFSET)</span></span><br><span class="line">BOARD_KERNEL_IMAGE_NAME := Image</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kernel - prebuilt</span></span><br><span class="line">TARGET_PREBUILT_DTB := <span class="variable">$(DEVICE_PATH)</span>/prebuilt/dtb.img</span><br><span class="line">BOARD_MKBOOTIMG_ARGS += --dtb <span class="variable">$(TARGET_PREBUILT_DTB)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Partitions</span></span><br><span class="line">BOARD_FLASH_BLOCK_SIZE := 262144</span><br><span class="line">BOARD_BOOTIMAGE_PARTITION_SIZE := 67108864</span><br><span class="line">BOARD_RECOVERYIMAGE_PARTITION_SIZE := 67108864</span><br><span class="line">BOARD_VENDOR_ROOTIMAGE_PARTITION_SIZE := 67108864</span><br><span class="line">BOARD_SYSTEMIMAGE_PARTITION_TYPE := ext4</span><br><span class="line">BOARD_USERDATAIMAGE_FILE_SYSTEM_TYPE := ext4</span><br><span class="line">BOARD_VENDORIMAGE_FILE_SYSTEM_TYPE := ext4</span><br><span class="line">TARGET_COPY_OUT_VENDOR := vendor</span><br><span class="line">BOARD_SUPER_PARTITION_SIZE := 9126805504</span><br><span class="line">BOARD_SUPER_PARTITION_GROUPS := xiaomi_dynamic_partitions</span><br><span class="line">BOARD_XIAOMI_DYNAMIC_PARTITIONS_PARTITION_LIST := system vendor product system_ext odm vendor_dlkm odm_dlkm</span><br><span class="line">BOARD_XIAOMI_DYNAMIC_PARTITIONS_SIZE := 9122611200</span><br><span class="line"></span><br><span class="line"><span class="comment"># Platform</span></span><br><span class="line">TARGET_BOARD_PLATFORM := mt6895</span><br><span class="line"></span><br><span class="line"><span class="comment"># Recovery</span></span><br><span class="line">BOARD_HAS_LARGE_FILESYSTEM := true</span><br><span class="line">TARGET_RECOVERY_PIXEL_FORMAT := RGBX_8888</span><br><span class="line">TARGET_USERIMAGES_USE_EXT4 := true</span><br><span class="line">TARGET_USERIMAGES_USE_F2FS := true</span><br><span class="line"></span><br><span class="line"><span class="comment"># Treble</span></span><br><span class="line">BOARD_VNDK_VERSION := current</span><br><span class="line"></span><br><span class="line"><span class="comment"># Vendor_boot recovery ramdisk</span></span><br><span class="line">BOARD_MOVE_RECOVERY_RESOURCES_TO_VENDOR_BOOT := true</span><br><span class="line"></span><br><span class="line"><span class="comment"># Boot recovery ramdisk</span></span><br><span class="line"><span class="comment">#BOARD_USES_RECOVERY_AS_BOOT := true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Verified Boot</span></span><br><span class="line">BOARD_AVB_ENABLE := true</span><br><span class="line">BOARD_AVB_MAKE_VBMETA_IMAGE_ARGS += --flags 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># TWRP Configurations</span></span><br><span class="line">TW_DEFAULT_LANGUAGE := zh_CN</span><br><span class="line">TW_EXTRA_LANGUAGES := true</span><br><span class="line">TW_THEME := portrait_hdpi</span><br><span class="line">TW_INCLUDE_FASTBOOTD := true</span><br><span class="line"></span><br><span class="line"><span class="comment"># Debug</span></span><br><span class="line">TARGET_USES_LOGD := true</span><br><span class="line">TWRP_INCLUDE_LOGCAT := true</span><br></pre></td></tr></table></figure>

<p>这块写了好久我也不确定对不对，请各位指正，尤其是 Kernel 部分。</p>
<h4 id="初始-device-mk-文件"><a href="#初始-device-mk-文件" class="headerlink" title="初始 device.mk 文件"></a>初始 device.mk 文件</h4><ul>
<li>准备好 prop.default</li>
</ul>
<p>选中 AndroidProducts.mk 并按照自己的资料复制并更改以下内容</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">DEVICE_PATH := device/xiaomi/rubens</span><br><span class="line"></span><br><span class="line"><span class="comment"># API</span></span><br><span class="line">PRODUCT_SHIPPING_API_LEVEL := 31 <span class="comment"># ro.board.first_api_level</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A/B</span></span><br><span class="line">AB_OTA_UPDATER := true <span class="comment"># 启用A/B无缝更新</span></span><br><span class="line">AB_OTA_PARTITIONS += \ <span class="comment"># 定义A/B分区，参考fstab</span></span><br><span class="line">    boot \</span><br><span class="line">    dtbo \</span><br><span class="line">    system \</span><br><span class="line">    product \</span><br><span class="line">    vendor \</span><br><span class="line">    odm \</span><br><span class="line">    odm_dlkm \</span><br><span class="line">    vbmeta \</span><br><span class="line">    vendor_boot \</span><br><span class="line">    vendor_dlkm \</span><br><span class="line">    vbmeta_system \</span><br><span class="line">    vbmeta_vendor</span><br><span class="line"></span><br><span class="line">PRODUCT_PACKAGES += \</span><br><span class="line">    update_engine \</span><br><span class="line">    update_engine_sideload \</span><br><span class="line">    update_verifier \</span><br><span class="line">    checkpoint_gc</span><br><span class="line"></span><br><span class="line">AB_OTA_POSTINSTALL_CONFIG += \</span><br><span class="line">    RUN_POSTINSTALL_system=true \</span><br><span class="line">    POSTINSTALL_PATH_system=system/bin/mtk_plpath_utils \</span><br><span class="line">    FILESYSTEM_TYPE_system=ext4 \</span><br><span class="line">    POSTINSTALL_OPTIONAL_system=true</span><br><span class="line"></span><br><span class="line">AB_OTA_POSTINSTALL_CONFIG += \</span><br><span class="line">    RUN_POSTINSTALL_vendor=true \</span><br><span class="line">    POSTINSTALL_PATH_vendor=bin/checkpoint_gc \</span><br><span class="line">    FILESYSTEM_TYPE_vendor=ext4 \</span><br><span class="line">    POSTINSTALL_OPTIONAL_vendor=true</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dynamic</span></span><br><span class="line">PRODUCT_USE_DYNAMIC_PARTITIONS := true <span class="comment"># 动态分区</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Soong namespaces</span></span><br><span class="line">PRODUCT_SOONG_NAMESPACES += <span class="variable">$(DEVICE_PATH)</span> <span class="comment"># 命名空间</span></span><br></pre></td></tr></table></figure>

<ul>
<li>A&#x2F;B 无缝更新部分高通和联发科不一样，联发科设备可以照抄，注意 system&#x2F;bin&#x2F;mtk_plpath_utils 就好。高通参考<a target="_blank" rel="noopener" href="https://github.com/sekaiacg/android_device_xiaomi_venus_TWRP/tree/android-13">venus twrp tree</a>，并且高通的<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/platform/hardware/qcom/bootctrl">bootctrl</a>和<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/platform/vendor/qcom-opensource/recovery-ext">gpt-utils</a>可以从 CLO 拿。</li>
</ul>
<p>无注释版</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_SHIPPING_API_LEVEL := 31</span><br><span class="line"></span><br><span class="line"><span class="comment"># A/B</span></span><br><span class="line">AB_OTA_UPDATER := true</span><br><span class="line">AB_OTA_PARTITIONS += \</span><br><span class="line">    boot \</span><br><span class="line">    dtbo \</span><br><span class="line">    system \</span><br><span class="line">    product \</span><br><span class="line">    vendor \</span><br><span class="line">    odm \</span><br><span class="line">    odm_dlkm \</span><br><span class="line">    vbmeta \</span><br><span class="line">    vendor_boot \</span><br><span class="line">    vendor_dlkm \</span><br><span class="line">    vbmeta_system \</span><br><span class="line">    vbmeta_vendor</span><br><span class="line"></span><br><span class="line">PRODUCT_PACKAGES += \</span><br><span class="line">    update_engine \</span><br><span class="line">    update_engine_sideload \</span><br><span class="line">    update_verifier \</span><br><span class="line">    checkpoint_gc</span><br><span class="line"></span><br><span class="line">AB_OTA_POSTINSTALL_CONFIG += \</span><br><span class="line">    RUN_POSTINSTALL_system=true \</span><br><span class="line">    POSTINSTALL_PATH_system=system/bin/mtk_plpath_utils \</span><br><span class="line">    FILESYSTEM_TYPE_system=ext4 \</span><br><span class="line">    POSTINSTALL_OPTIONAL_system=true</span><br><span class="line"></span><br><span class="line">AB_OTA_POSTINSTALL_CONFIG += \</span><br><span class="line">    RUN_POSTINSTALL_vendor=true \</span><br><span class="line">    POSTINSTALL_PATH_vendor=bin/checkpoint_gc \</span><br><span class="line">    FILESYSTEM_TYPE_vendor=ext4 \</span><br><span class="line">    POSTINSTALL_OPTIONAL_vendor=true</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dynamic</span></span><br><span class="line">PRODUCT_USE_DYNAMIC_PARTITIONS := true</span><br><span class="line"></span><br><span class="line"><span class="comment"># Soong namespaces</span></span><br><span class="line">PRODUCT_SOONG_NAMESPACES += <span class="variable">$(DEVICE_PATH)</span></span><br></pre></td></tr></table></figure>

<h4 id="初始-twrp-rubens-mk-文件"><a href="#初始-twrp-rubens-mk-文件" class="headerlink" title="初始 twrp_rubens.mk 文件"></a>初始 twrp_rubens.mk 文件</h4><p>选中 AndroidProducts.mk 并按照自己的资料复制并更改以下内容</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Inherit from common AOSP config</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> inherit-product, <span class="variable">$(SRC_TARGET_DIR)</span>/product/base.mk)</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> inherit-product, <span class="variable">$(SRC_TARGET_DIR)</span>/product/core_64_bit_only.mk)</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> inherit-product, <span class="variable">$(SRC_TARGET_DIR)</span>/product/virtual_ab_ota/launch_with_vendor_ramdisk.mk)</span> <span class="comment"># vab加载到vendor boot里使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Inherit from TWRP product configuration</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> inherit-product, vendor/twrp/config/common.mk)</span> <span class="comment"># twrp-9分支改为onmi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Device specific configs</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> inherit-product, device/xiaomi/rubens/device.mk)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Device identifier</span></span><br><span class="line">PRODUCT_DEVICE := rubens <span class="comment"># 设备型号</span></span><br><span class="line">PRODUCT_NAME := twrp_rubens <span class="comment"># 设备名称</span></span><br><span class="line">PRODUCT_BRAND := Redmi <span class="comment"># 自定义品牌，如果有</span></span><br><span class="line">PRODUCT_MODEL := 22041211AC <span class="comment"># 产品最终用户可见名称</span></span><br><span class="line">PRODUCT_MANUFACTURER := Xiaomi <span class="comment"># 制造商</span></span><br><span class="line"></span><br><span class="line">PRODUCT_PROPERTY_OVERRIDES += ro.twrp.vendor_boot=true <span class="comment"># 对twrp启动vendor_boot支持</span></span><br></pre></td></tr></table></figure>

<p>无注释版</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Inherit from common AOSP config</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> inherit-product, <span class="variable">$(SRC_TARGET_DIR)</span>/product/base.mk)</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> inherit-product, <span class="variable">$(SRC_TARGET_DIR)</span>/product/core_64_bit_only.mk)</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> inherit-product, <span class="variable">$(SRC_TARGET_DIR)</span>/product/virtual_ab_ota/launch_with_vendor_ramdisk.mk)</span> <span class="comment"># vab加载到vendor boot里使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Inherit from TWRP product configuration</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> inherit-product, vendor/twrp/config/common.mk)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Device specific configs</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> inherit-product, device/xiaomi/rubens/device.mk)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Device identifier</span></span><br><span class="line">PRODUCT_DEVICE := rubens</span><br><span class="line">PRODUCT_NAME := twrp_rubens</span><br><span class="line">PRODUCT_BRAND := Redmi</span><br><span class="line">PRODUCT_MODEL := 22041211AC</span><br><span class="line">PRODUCT_MANUFACTURER := Xiaomi</span><br><span class="line"></span><br><span class="line">PRODUCT_PROPERTY_OVERRIDES += ro.twrp.vendor_boot=true</span><br></pre></td></tr></table></figure>

<h4 id="初始-recovery-目录"><a href="#初始-recovery-目录" class="headerlink" title="初始 recovery 目录"></a>初始 recovery 目录</h4><blockquote>
<p>拿出我们好久之前准备的 ramdisk 叭</p>
</blockquote>
<p>通过<code>tree</code>命令我们可以查看 ramdisk 的树状图，可以很清晰的查看包含的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">├── acct</span><br><span class="line">├── apex</span><br><span class="line">├── bin -&gt; /system/bin</span><br><span class="line">├── bugreports -&gt; /data/user_de/0/com.android.shell/files/bugreports</span><br><span class="line">├── config</span><br><span class="line">├── d -&gt; /sys/kernel/debug</span><br><span class="line">├── data</span><br><span class="line">├── data_mirror</span><br><span class="line">├── debug_ramdisk</span><br><span class="line">├── default.prop -&gt; prop.default</span><br><span class="line">├── dev</span><br><span class="line">├── etc -&gt; /system/etc</span><br><span class="line">├── first_stage_ramdisk</span><br><span class="line">│   ├── fstab.emmc</span><br><span class="line">│   ├── fstab.mt6895</span><br><span class="line">│   └── system</span><br><span class="line">│       ├── bin</span><br><span class="line">│       │   ├── e2fsck</span><br><span class="line">│       │   ├── linker64</span><br><span class="line">│       │   ├── linker_asan64 -&gt; linker64</span><br><span class="line">│       │   └── snapuserd</span><br><span class="line">│       └── lib64</span><br><span class="line">│           ├── ld-android.so</span><br><span class="line">│           ├── libbase.so</span><br><span class="line">│           ├── libc++.so</span><br><span class="line">│           ├── libc.so</span><br><span class="line">│           ├── libdl.so</span><br><span class="line">│           ├── libext2_blkid.so</span><br><span class="line">│           ├── libext2_com_err.so</span><br><span class="line">│           ├── libext2_e2p.so</span><br><span class="line">│           ├── libext2_quota.so</span><br><span class="line">│           ├── libext2_uuid.so</span><br><span class="line">│           ├── libext2fs.so</span><br><span class="line">│           ├── liblog.so</span><br><span class="line">│           ├── libm.so</span><br><span class="line">│           ├── libsparse.so</span><br><span class="line">│           └── libz.so</span><br><span class="line">├── init -&gt; /system/bin/init</span><br><span class="line">├── init.recovery.hardware.rc</span><br><span class="line">├── init.recovery.mt6895.rc</span><br><span class="line">└── 等等等等...省略大概1000个文件吧</span><br></pre></td></tr></table></figure>

<blockquote>
<p>因为避免教程时效性，我们尽可能选取 prebuilt 的办法，如 boot 和 mtk_plpath_utils 都采用预编译。</p>
</blockquote>
<p>里面有很多文件是没用的，整理一下，对我们有用的只有这些</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── first_stage_ramdisk</span><br><span class="line">│   ├── fstab.emmc</span><br><span class="line">│   └── fstab.mt6895</span><br><span class="line">├── init.recovery.mt6895.rc</span><br><span class="line">├── lib</span><br><span class="line">│   └── modules</span><br><span class="line">│       ├── 8250_mtk.ko</span><br><span class="line">│       ├── adapter_class.ko</span><br><span class="line">│       ├── adsp.ko</span><br><span class="line">│       ├── aee_aed.ko</span><br><span class="line">│       ├── aee_hangdet.ko</span><br><span class="line">│       ├── aee_rs.ko</span><br><span class="line">│       ├── blocktag.ko</span><br><span class="line">│       ├── bootprof.ko</span><br><span class="line">│       ├── bq28z610.ko</span><br><span class="line">│       ├── cache-parity.ko</span><br><span class="line">│       ├── cfg80211.ko</span><br><span class="line">│       ├── charger_class.ko</span><br><span class="line">│       └── 省略一百多个模块，这个目录里的东西全要</span><br><span class="line">└── system</span><br><span class="line">    ├── bin</span><br><span class="line">    │   └── mtk_plpath_utils</span><br><span class="line">    ├── etc</span><br><span class="line">    │   ├── init</span><br><span class="line">    │   │   │── mtk-plpath-utils.rc</span><br><span class="line">    │   │   └──hw</span><br><span class="line">    │   │      └──init.rc</span><br><span class="line">    │   ├── recovery.fstab</span><br><span class="line">    │   ├── security</span><br><span class="line">    │   │   └── otacerts.zip</span><br><span class="line">    │   └── ueventd.rc</span><br><span class="line">    └── lib64</span><br><span class="line">        └── hw</span><br><span class="line">            └── android.hardware.boot@1.0-impl-1.2-mtkimpl.so</span><br></pre></td></tr></table></figure>

<p>将它们按照以下操作复制</p>
<ul>
<li>first_stage_ramdisk –&gt; recovery&#x2F;root&#x2F;first_stage_ramdisk</li>
<li>init.recovery.mt6895.rc –&gt; recovery&#x2F;root&#x2F;init.recovery.mt6895.rc</li>
<li>lib –&gt; recovery&#x2F;root&#x2F;lib</li>
<li>system –&gt; recovery&#x2F;root&#x2F;system (security 和 hw 文件夹里的内容作为备用，不要复制进去)<br>得到以下目录结构</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Android.mk</span><br><span class="line">├── AndroidProducts.mk</span><br><span class="line">├── BoardConfig.mk</span><br><span class="line">├── device.mk</span><br><span class="line">├── prebuilt</span><br><span class="line">├── recovery</span><br><span class="line">│   └── root</span><br><span class="line">│       ├── first_stage_ramdisk</span><br><span class="line">│       │   ├── fstab.emmc</span><br><span class="line">│       │   └── fstab.mt6895</span><br><span class="line">│       ├── init.recovery.mt6895.rc</span><br><span class="line">│       ├── lib</span><br><span class="line">│       │   └── modules</span><br><span class="line">│       │       ├── 8250_mtk.ko</span><br><span class="line">│       │       ├── adapter_class.ko</span><br><span class="line">│       │       ├── adsp.ko</span><br><span class="line">│       │       ├── aee_aed.ko</span><br><span class="line">│       │       ├── aee_hangdet.ko</span><br><span class="line">│       │       ├── aee_rs.ko</span><br><span class="line">│       │       ├── blocktag.ko</span><br><span class="line">│       │       └── 省略....</span><br><span class="line">│       └── system</span><br><span class="line">│           ├── bin</span><br><span class="line">│           │   └── mtk_plpath_utils</span><br><span class="line">│           ├── etc</span><br><span class="line">│           │   ├── recovery.fstab</span><br><span class="line">│           │   └── ueventd.rc</span><br><span class="line">│           └── lib64</span><br><span class="line">│               └── hw</span><br><span class="line">│                   └── android.hardware.boot@1.0-impl-1.2-mtkimpl.so</span><br><span class="line">└── twrp_rubens.mk</span><br></pre></td></tr></table></figure>

<p>打开 init.recovery.mt6895.rc 添加</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">on boot</span><br><span class="line">    start health-hal-2-1</span><br><span class="line"></span><br><span class="line">on post-fs</span><br><span class="line">    start boot-hal-1-2</span><br></pre></td></tr></table></figure>

<p>例如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">on post-fs</span><br><span class="line">    start boot-hal-1-2</span><br><span class="line"></span><br><span class="line">on init</span><br><span class="line">    setprop sys.usb.configfs 1</span><br><span class="line">    setprop sys.usb.controller &quot;11201000.usb0&quot;</span><br><span class="line">    setprop sys.usb.ffs.aio_compat 1</span><br><span class="line"></span><br><span class="line">on fs &amp;&amp; property:ro.debuggable=0</span><br><span class="line">    # distinguish USB shoulde connect or not, i.e. CDP vs SDP</span><br><span class="line">    # set charging free due to it wait for USB activation</span><br><span class="line"></span><br><span class="line">on boot</span><br><span class="line">    start health-hal-2-1</span><br><span class="line">    exec u:r:update_engine:s0 root root -- /system/bin/mtk_plpath_utils</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来可以开始编译咯~~</p>
<h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><blockquote>
<p>编译前请检查注释是否全部删除</p>
</blockquote>
<p>twrp 源码根目录执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">. build/envsetup.sh</span><br><span class="line">lunch twrp_codename-eng # twrp-9为onmi</span><br><span class="line">mka vendorbootimg/bootimage/recoveryimage</span><br></pre></td></tr></table></figure>

<p>不出意外的话一路绿灯，如果有报错的话请发邮箱至 <a href="mailto:&#49;&#x35;&#x39;&#50;&#x35;&#x30;&#49;&#54;&#48;&#53;&#64;&#113;&#113;&#46;&#99;&#111;&#109;">&#49;&#x35;&#x39;&#50;&#x35;&#x30;&#49;&#54;&#48;&#53;&#64;&#113;&#113;&#46;&#99;&#111;&#109;</a> 咨询我</p>
<p>产物在 <code>out/target/product/codename/vendor_boot.img\boot.img\recovery.img</code><br>手机重启到 fastboot 模式，使用 fastboot flash 刷写，例如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastboot flash vendor_boot /Users/xiaolegun/Downloads/vendor_boot.img</span><br></pre></td></tr></table></figure>

<p>则输出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ERROR: could not clear input pipe; result e0005000, ignoring...</span><br><span class="line">ERROR: could not clear output pipe; result e0005000, ignoring....</span><br><span class="line">Sending &#x27;vendor_boot_a&#x27; (65536 KB)                 OKAY [  1.396s]</span><br><span class="line">Writing &#x27;vendor_boot_a&#x27;                            OKAY [  0.167s]</span><br><span class="line">Finished. Total time: 1.625s</span><br></pre></td></tr></table></figure>

<p>就可以重启按电源加音量上尝试了，我自己是一次点亮，但有 bug。</p>
<h4 id="修-BUG"><a href="#修-BUG" class="headerlink" title="修 BUG"></a>修 BUG</h4><h5 id="修复-USB"><a href="#修复-USB" class="headerlink" title="修复 USB"></a>修复 USB</h5><p>我看到 twrp 控制台有很多报错，第一步肯定是先获取日志，使用<code>logcat</code>命令获取，在此之前先使用<code>adb devices</code>检测一下设备 usb 是否工作正常。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~  adb devices          ✔  10208  10:05:31</span><br><span class="line">* daemon not running; starting now at tcp:5037</span><br><span class="line">* daemon started successfully</span><br><span class="line">List of devices attached</span><br></pre></td></tr></table></figure>

<p>可以看到<code>adb</code>没有检测到设备，原因一般是 usb 的配置不对，但 usb 是好的。这时可以尝试关闭 mtp，再开启，如果电脑有反应，那么就可以继续下一步了。<br>在设备树中的 recovery&#x2F;root，创建 init.recovery.usb.rc 的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch recovery/root/init.recovery.usb.rc</span><br></pre></td></tr></table></figure>

<p>并导入以下内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">on property:sys.usb.config=mtp,adb</span><br><span class="line">    start adbd</span><br><span class="line"></span><br><span class="line">on property:sys.usb.ffs.ready=1 &amp;&amp; property:sys.usb.config=mtp,adb</span><br><span class="line">    write /config/usb_gadget/g1/configs/b.1/strings/0x409/configuration &quot;mtp_adb&quot;</span><br><span class="line">    rm /config/usb_gadget/g1/configs/b.1/f1</span><br><span class="line">    rm /config/usb_gadget/g1/configs/b.1/f2</span><br><span class="line">    rm /config/usb_gadget/g1/configs/b.1/f3</span><br><span class="line">    rm /config/usb_gadget/g1/configs/b.1/f4</span><br><span class="line">    rm /config/usb_gadget/g1/configs/b.1/f5</span><br><span class="line">    write /config/usb_gadget/g1/idVendor 0x18d1</span><br><span class="line">    write /config/usb_gadget/g1/idProduct 0x2d08</span><br><span class="line">    symlink /config/usb_gadget/g1/functions/mtp.gs0 /config/usb_gadget/g1/configs/b.1/f1</span><br><span class="line">    symlink /config/usb_gadget/g1/functions/ffs.adb /config/usb_gadget/g1/configs/b.1/f2</span><br><span class="line">    write /config/usb_gadget/g1/UDC $&#123;sys.usb.controller&#125;</span><br><span class="line">    setprop sys.usb.state $&#123;sys.usb.config&#125;</span><br></pre></td></tr></table></figure>

<p>这是我从我维护的 MI 6X 的 device tree 拿过来的，可以在联发科设备上正常工作。这段 shell 的大致意思就是在 usb 配置节点写入 mtp 和 adb 同时工作的字符串，这样 adb 就能顺利工作了。</p>
<p>此外打开原厂 init.rc 修正一下 usb 设备的 id</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MIUI ADD: START</span></span><br><span class="line">import /init.recovery.hardware.rc</span><br><span class="line">import /miui.factoryreset.rc</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">END</span></span><br><span class="line">import /init.recovery.$&#123;ro.hardware&#125;.rc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">########## 省略一万字</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MIUI ADD: START</span></span><br><span class="line">on property:sys.usb.config=mtp,adb &amp;&amp; property:sys.usb.configfs=0</span><br><span class="line">    write /sys/class/android_usb/android0/enable 0</span><br><span class="line">    write /sys/class/android_usb/android0/idVendor 2717</span><br><span class="line">    write /sys/class/android_usb/android0/idProduct 904D</span><br><span class="line">    write /sys/class/android_usb/android0/functions mtp,adb</span><br><span class="line">    write /sys/class/android_usb/android0/enable 1</span><br><span class="line">    setprop sys.usb.state  $&#123;sys.usb.config&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">END</span></span><br></pre></td></tr></table></figure>

<p>将<code>/sys/class/android_usb/android0/idVendor</code>和<code>write /sys/class/android_usb/android0/idProduct</code>后面的 id 分别替换到<code>/config/usb_gadget/g1/idVendor</code>和<code>/config/usb_gadget/g1/idProduct</code>处理完就是这样的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">on property:sys.usb.config=mtp,adb</span><br><span class="line">    start adbd</span><br><span class="line"></span><br><span class="line">on property:sys.usb.ffs.ready=1 &amp;&amp; property:sys.usb.config=mtp,adb</span><br><span class="line">    write /config/usb_gadget/g1/configs/b.1/strings/0x409/configuration &quot;mtp_adb&quot;</span><br><span class="line">    rm /config/usb_gadget/g1/configs/b.1/f1</span><br><span class="line">    rm /config/usb_gadget/g1/configs/b.1/f2</span><br><span class="line">    rm /config/usb_gadget/g1/configs/b.1/f3</span><br><span class="line">    rm /config/usb_gadget/g1/configs/b.1/f4</span><br><span class="line">    rm /config/usb_gadget/g1/configs/b.1/f5</span><br><span class="line">    write /config/usb_gadget/g1/idVendor 0x2717</span><br><span class="line">    write /config/usb_gadget/g1/idProduct 0x904D</span><br><span class="line">    symlink /config/usb_gadget/g1/functions/mtp.gs0 /config/usb_gadget/g1/configs/b.1/f1</span><br><span class="line">    symlink /config/usb_gadget/g1/functions/ffs.adb /config/usb_gadget/g1/configs/b.1/f2</span><br><span class="line">    write /config/usb_gadget/g1/UDC $&#123;sys.usb.controller&#125;</span><br><span class="line">    setprop sys.usb.state $&#123;sys.usb.config&#125;</span><br></pre></td></tr></table></figure>

<p>接下来开机之后 adb 和 mtp 就能同时工作了。</p>
<h5 id="修复-Resetprop"><a href="#修复-Resetprop" class="headerlink" title="修复 Resetprop"></a>修复 Resetprop</h5><p>接下来就可以修复其它 bug 了，我看到控制台有一堆红色的报错:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">E:Unknown File System:&#x27;/mi_ext&#x27;</span><br><span class="line">E:Unable to override &#x27;external_storage.projid.enabled&#x27; due to missing libresetprop</span><br><span class="line">挂载“/data”失败(Invalid argument)</span><br></pre></td></tr></table></figure>

<p>这三个报错中第二个最好修，第一个次之，第三个与解密有关，放在另一个大章节讲。<br>第二个报错只需要在 BoardConfig.mk 中添加</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Tool</span></span><br><span class="line">TW_INCLUDE_RESETPROP := true</span><br><span class="line">TW_INCLUDE_LIBRESETPROP := true</span><br></pre></td></tr></table></figure>

<p>不用编译测试直接秒杀</p>
<h5 id="修复挂载"><a href="#修复挂载" class="headerlink" title="修复挂载"></a>修复挂载</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:Unknown File System:&#x27;/mi_ext&#x27;</span><br></pre></td></tr></table></figure>

<p>我们打开 recovery&#x2F;root&#x2F;system&#x2F;etc 中的 recovery.fstab，发现里面有很多空格，我们先将它格式化一下，有实力的可以把后面的 flag 也对齐整理好。<br>我比较没实力，简单格式化了一下，是这样的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"># 1 &quot;vendor/mediatek/proprietary/hardware/fstab/mt6895/fstab.in.mt6895&quot;</span><br><span class="line"># 1 &quot;&lt;built-in&gt;&quot; 1</span><br><span class="line"># 1 &quot;&lt;built-in&gt;&quot; 3</span><br><span class="line"># 341 &quot;&lt;built-in&gt;&quot; 3</span><br><span class="line"># 1 &quot;&lt;command line&gt;&quot; 1</span><br><span class="line"># 1 &quot;&lt;built-in&gt;&quot; 2</span><br><span class="line"># 1 &quot;vendor/mediatek/proprietary/hardware/fstab/mt6895/fstab.in.mt6895&quot; 2</span><br><span class="line"># 173 &quot;vendor/mediatek/proprietary/hardware/fstab/mt6895/fstab.in.mt6895&quot;</span><br><span class="line">system /system erofs ro wait,slotselect,avb=vbmeta_system,logical,first_stage_mount,avb_keys=/avb/q-gsi.avbpubkey:/avb/r-gsi.avbpubkey:/avb/s-gsi.avbpubkey</span><br><span class="line">system /system ext4 ro wait,slotselect,avb=vbmeta_system,logical,first_stage_mount,avb_keys=/avb/q-gsi.avbpubkey:/avb/r-gsi.avbpubkey:/avb/s-gsi.avbpubkey</span><br><span class="line">vendor /vendor erofs ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">vendor /vendor ext4 ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">product /product erofs ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">product /product ext4 ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">mi_ext /mnt/vendor/mi_ext erofs ro wait,slotselect,avb=vbmeta,logical,first_stage_mount,nofail</span><br><span class="line">mi_ext /mnt/vendor/mi_ext ext4 ro wait,slotselect,avb=vbmeta,logical,first_stage_mount,nofail</span><br><span class="line">/mnt/vendor/mi_ext /mi_ext none ro,bind wait,nofail</span><br><span class="line">overlay /product/overlay overlay ro,lowerdir=/mnt/vendor/mi_ext/product/overlay/:/product/overlay check,nofail</span><br><span class="line">overlay /product/app overlay ro,lowerdir=/mnt/vendor/mi_ext/product/app/:/product/app check,nofail</span><br><span class="line">overlay /product/priv-app overlay ro,lowerdir=/mnt/vendor/mi_ext/product/priv-app/:/product/priv-app check,nofail</span><br><span class="line">overlay /product/lib overlay ro,lowerdir=/mnt/vendor/mi_ext/product/lib/:/product/lib check,nofail</span><br><span class="line">overlay /product/lib64 overlay ro,lowerdir=/mnt/vendor/mi_ext/product/lib64/:/product/lib64 check,nofail</span><br><span class="line">overlay /product/bin overlay ro,lowerdir=/mnt/vendor/mi_ext/product/bin/:/product/bin check,nofail</span><br><span class="line">overlay /product/framework overlay ro,lowerdir=/mnt/vendor/mi_ext/product/framework/:/product/framework check,nofail</span><br><span class="line">overlay /product/media overlay ro,lowerdir=/mnt/vendor/mi_ext/product/media/:/product/media check,nofail</span><br><span class="line">overlay /product/opcust overlay ro,lowerdir=/mnt/vendor/mi_ext/product/opcust/:/product/opcust check,nofail</span><br><span class="line">overlay /product/data-app overlay ro,lowerdir=/mnt/vendor/mi_ext/product/data-app/:/product/data-app check,nofail</span><br><span class="line">overlay /product/etc/sysconfig overlay ro,lowerdir=/mnt/vendor/mi_ext/product/etc/sysconfig/:/product/etc/sysconfig check,nofail</span><br><span class="line">overlay /product/etc/permissions overlay ro,lowerdir=/mnt/vendor/mi_ext/product/etc/permissions/:/product/etc/permissions check,nofail</span><br><span class="line">overlay /system/app overlay ro,lowerdir=/mnt/vendor/mi_ext/system/app/:/product/pangu/system/app/:/system/app check,nofail</span><br><span class="line">overlay /system/priv-app overlay ro,lowerdir=/mnt/vendor/mi_ext/system/priv-app/:/product/pangu/system/priv-app/:/system/priv-app check,nofail</span><br><span class="line">overlay /system/framework overlay ro,lowerdir=/product/pangu/system/framework/:/system/framework check,nofail</span><br><span class="line">overlay /system/etc/sysconfig overlay ro,lowerdir=/mnt/vendor/mi_ext/system/etc/sysconfig/:/system/etc/sysconfig check,nofail</span><br><span class="line">overlay /system/etc/permissions overlay ro,lowerdir=/mnt/vendor/mi_ext/system/etc/permissions/:/product/pangu/system/etc/permissions/:/system/etc/permissions check,nofail</span><br><span class="line">system_ext /system_ext erofs ro wait,slotselect,avb=vbmeta_system,logical,first_stage_mount,avb_keys=/avb/q-gsi.avbpubkey:/avb/r-gsi.avbpubkey:/avb/s-gsi.avbpubkey</span><br><span class="line">system_ext /system_ext ext4 ro wait,slotselect,avb=vbmeta_system,logical,first_stage_mount,avb_keys=/avb/q-gsi.avbpubkey:/avb/r-gsi.avbpubkey:/avb/s-gsi.avbpubkey</span><br><span class="line">odm /odm erofs ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">odm /odm ext4 ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">vendor_dlkm /vendor_dlkm erofs ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">odm_dlkm /odm_dlkm erofs ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">/dev/block/by-name/metadata /metadata ext4 noatime,nosuid,nodev,discard wait,check,formattable,first_stage_mount</span><br><span class="line">/dev/block/by-name/userdata /data f2fs noatime,nosuid,nodev,discard,noflush_merge,fsync_mode=nobarrier,reserve_root=134217,resgid=1065,checkpoint_merge,gc_merge,inlinecrypt wait,check,formattable,quota,latemount,resize,reservedsize=128m,checkpoint=fs,fileencryption=aes-256-xts:aes-256-cts:v2+inlinecrypt_optimized,keydirectory=/metadata/vold/metadata_encryption,fsverity</span><br><span class="line">/dev/block/by-name/rescue /cache ext4 noatime,nosuid,nodev,noauto_da_alloc,discard wait,check,formattable</span><br><span class="line">/dev/block/by-name/protect1 /mnt/vendor/protect_f ext4 noatime,nosuid,nodev,noauto_da_alloc,commit=1,nodelalloc wait,check,formattable</span><br><span class="line">/dev/block/by-name/protect2 /mnt/vendor/protect_s ext4 noatime,nosuid,nodev,noauto_da_alloc,commit=1,nodelalloc wait,check,formattable</span><br><span class="line">/dev/block/by-name/nvdata /mnt/vendor/nvdata ext4 noatime,nosuid,nodev,noauto_da_alloc,commit=1,nodelalloc wait,check,formattable</span><br><span class="line">/dev/block/by-name/nvcfg /mnt/vendor/nvcfg ext4 noatime,nosuid,nodev,noauto_da_alloc,commit=1,nodelalloc wait,check,formattable</span><br><span class="line">/dev/block/by-name/persist /mnt/vendor/persist ext4 noatime,nosuid,nodev,noauto_da_alloc,commit=1,nodelalloc wait,check,formattable</span><br><span class="line">/devices/platform/soc/11240000.mmc* auto auto defaults voldmanaged=sdcard1:auto,encryptable=userdata</span><br><span class="line">/devices/platform/usb_xhci* auto vfat defaults voldmanaged=usbotg:auto</span><br><span class="line">/devices/platform/soc/11201000.usb0/11200000.xhci* auto vfat defaults voldmanaged=usbotg:auto</span><br><span class="line">/dev/block/by-name/frp /persistent emmc defaults defaults</span><br><span class="line">/dev/block/by-name/nvram /nvram emmc defaults defaults</span><br><span class="line">/dev/block/by-name/proinfo /proinfo emmc defaults defaults</span><br><span class="line">/dev/block/by-name/lk /bootloader emmc defaults defaults</span><br><span class="line">/dev/block/by-name/lk2 /bootloader2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/para /para emmc defaults defaults</span><br><span class="line">/dev/block/by-name/misc /misc emmc defaults defaults</span><br><span class="line">/dev/block/by-name/boot /boot emmc defaults first_stage_mount,nofail,slotselect</span><br><span class="line">/dev/block/by-name/vbmeta_vendor /vbmeta_vendor emmc defaults first_stage_mount,nofail,slotselect</span><br><span class="line">/dev/block/by-name/vbmeta_system /vbmeta_system emmc defaults first_stage_mount,nofail,slotselect,avb=vbmeta</span><br><span class="line">/dev/block/by-name/logo /logo emmc defaults defaults</span><br><span class="line">/dev/block/by-name/expdb /expdb emmc defaults defaults</span><br><span class="line">/dev/block/by-name/seccfg /seccfg emmc defaults defaults</span><br><span class="line">/dev/block/by-name/tee1 /tee1 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/tee2 /tee2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/scp1 /scp1 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/scp2 /scp2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/sspm_1 /sspm_1 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/sspm_2 /sspm_2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/dpm_1 /dpm_1 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/dpm_2 /dpm_2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/mcupm_1 /mcupm_1 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/mcupm_2 /mcupm_2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/md1img /md1img emmc defaults defaults</span><br><span class="line">/dev/block/by-name/md1dsp /md1dsp emmc defaults defaults</span><br><span class="line">/dev/block/by-name/md1arm7 /md1arm7 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/md3img /md3img emmc defaults defaults</span><br><span class="line">/dev/block/by-name/gz1 /gz1 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/gz2 /gz2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/spmfw /spmfw emmc defaults defaults</span><br><span class="line">/dev/block/by-name/audio_dsp /audio_dsp emmc defaults defaults</span><br><span class="line">/dev/block/by-name/pi_img /pi_img emmc defaults defaults</span><br><span class="line">/dev/block/by-name/boot_para /boot_para emmc defaults defaults</span><br><span class="line">/dev/block/by-name/odmdtbo /odmdtbo emmc defaults defaults</span><br><span class="line">/dev/block/by-name/dtbo /dtbo emmc defaults defaults</span><br><span class="line">/dev/block/by-name/otp /otp emmc defaults defaults</span><br><span class="line">/dev/block/by-name/vbmeta /vbmeta emmc defaults defaults</span><br></pre></td></tr></table></figure>

<p>这里面有很多无用分区，我们在 twrp 中操作不到，但是我也是第一次适配 MTK 设备，所以不“瞎说”误人子弟了，先把 bug 修好。<br>像 xiaomi 这样常见的挂载错误，我自己一般都是尝试把&#x2F;mnt&#x2F;vendor 使用 vscode 全部删除，让我们尝试一下。并且要把这一行删除，这行在我看来是重复定义（？而且也没指定分区格式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/mnt/vendor/mi_ext /mi_ext none ro,bind wait,nofail</span><br></pre></td></tr></table></figure>

<p>整理完之后是这样的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"># 1 &quot;vendor/mediatek/proprietary/hardware/fstab/mt6895/fstab.in.mt6895&quot;</span><br><span class="line"># 1 &quot;&lt;built-in&gt;&quot; 1</span><br><span class="line"># 1 &quot;&lt;built-in&gt;&quot; 3</span><br><span class="line"># 341 &quot;&lt;built-in&gt;&quot; 3</span><br><span class="line"># 1 &quot;&lt;command line&gt;&quot; 1</span><br><span class="line"># 1 &quot;&lt;built-in&gt;&quot; 2</span><br><span class="line"># 1 &quot;vendor/mediatek/proprietary/hardware/fstab/mt6895/fstab.in.mt6895&quot; 2</span><br><span class="line"># 173 &quot;vendor/mediatek/proprietary/hardware/fstab/mt6895/fstab.in.mt6895&quot;</span><br><span class="line">system /system erofs ro wait,slotselect,avb=vbmeta_system,logical,first_stage_mount,avb_keys=/avb/q-gsi.avbpubkey:/avb/r-gsi.avbpubkey:/avb/s-gsi.avbpubkey</span><br><span class="line">system /system ext4 ro wait,slotselect,avb=vbmeta_system,logical,first_stage_mount,avb_keys=/avb/q-gsi.avbpubkey:/avb/r-gsi.avbpubkey:/avb/s-gsi.avbpubkey</span><br><span class="line">vendor /vendor erofs ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">vendor /vendor ext4 ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">product /product erofs ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">product /product ext4 ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">mi_ext /mi_ext erofs ro wait,slotselect,avb=vbmeta,logical,first_stage_mount,nofail</span><br><span class="line">mi_ext /mi_ext ext4 ro wait,slotselect,avb=vbmeta,logical,first_stage_mount,nofail</span><br><span class="line">overlay /product/overlay overlay ro,lowerdir=/mi_ext/product/overlay/:/product/overlay check,nofail</span><br><span class="line">overlay /product/app overlay ro,lowerdir=/mi_ext/product/app/:/product/app check,nofail</span><br><span class="line">overlay /product/priv-app overlay ro,lowerdir=/mi_ext/product/priv-app/:/product/priv-app check,nofail</span><br><span class="line">overlay /product/lib overlay ro,lowerdir=/mi_ext/product/lib/:/product/lib check,nofail</span><br><span class="line">overlay /product/lib64 overlay ro,lowerdir=/mi_ext/product/lib64/:/product/lib64 check,nofail</span><br><span class="line">overlay /product/bin overlay ro,lowerdir=/mi_ext/product/bin/:/product/bin check,nofail</span><br><span class="line">overlay /product/framework overlay ro,lowerdir=/mi_ext/product/framework/:/product/framework check,nofail</span><br><span class="line">overlay /product/media overlay ro,lowerdir=/mi_ext/product/media/:/product/media check,nofail</span><br><span class="line">overlay /product/opcust overlay ro,lowerdir=/mi_ext/product/opcust/:/product/opcust check,nofail</span><br><span class="line">overlay /product/data-app overlay ro,lowerdir=/mi_ext/product/data-app/:/product/data-app check,nofail</span><br><span class="line">overlay /product/etc/sysconfig overlay ro,lowerdir=/mi_ext/product/etc/sysconfig/:/product/etc/sysconfig check,nofail</span><br><span class="line">overlay /product/etc/permissions overlay ro,lowerdir=/mi_ext/product/etc/permissions/:/product/etc/permissions check,nofail</span><br><span class="line">overlay /system/app overlay ro,lowerdir=/mi_ext/system/app/:/product/pangu/system/app/:/system/app check,nofail</span><br><span class="line">overlay /system/priv-app overlay ro,lowerdir=/mi_ext/system/priv-app/:/product/pangu/system/priv-app/:/system/priv-app check,nofail</span><br><span class="line">overlay /system/framework overlay ro,lowerdir=/product/pangu/system/framework/:/system/framework check,nofail</span><br><span class="line">overlay /system/etc/sysconfig overlay ro,lowerdir=/mi_ext/system/etc/sysconfig/:/system/etc/sysconfig check,nofail</span><br><span class="line">overlay /system/etc/permissions overlay ro,lowerdir=/mi_ext/system/etc/permissions/:/product/pangu/system/etc/permissions/:/system/etc/permissions check,nofail</span><br><span class="line">system_ext /system_ext erofs ro wait,slotselect,avb=vbmeta_system,logical,first_stage_mount,avb_keys=/avb/q-gsi.avbpubkey:/avb/r-gsi.avbpubkey:/avb/s-gsi.avbpubkey</span><br><span class="line">system_ext /system_ext ext4 ro wait,slotselect,avb=vbmeta_system,logical,first_stage_mount,avb_keys=/avb/q-gsi.avbpubkey:/avb/r-gsi.avbpubkey:/avb/s-gsi.avbpubkey</span><br><span class="line">odm /odm erofs ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">odm /odm ext4 ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">vendor_dlkm /vendor_dlkm erofs ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">odm_dlkm /odm_dlkm erofs ro wait,slotselect,avb,logical,first_stage_mount</span><br><span class="line">/dev/block/by-name/metadata /metadata ext4 noatime,nosuid,nodev,discard wait,check,formattable,first_stage_mount</span><br><span class="line">/dev/block/by-name/userdata /data f2fs noatime,nosuid,nodev,discard,noflush_merge,fsync_mode=nobarrier,reserve_root=134217,resgid=1065,checkpoint_merge,gc_merge,inlinecrypt wait,check,formattable,quota,latemount,resize,reservedsize=128m,checkpoint=fs,fileencryption=aes-256-xts:aes-256-cts:v2+inlinecrypt_optimized,keydirectory=/metadata/vold/metadata_encryption,fsverity</span><br><span class="line">/dev/block/by-name/rescue /cache ext4 noatime,nosuid,nodev,noauto_da_alloc,discard wait,check,formattable</span><br><span class="line">/dev/block/by-name/protect1 /protect_f ext4 noatime,nosuid,nodev,noauto_da_alloc,commit=1,nodelalloc wait,check,formattable</span><br><span class="line">/dev/block/by-name/protect2 /protect_s ext4 noatime,nosuid,nodev,noauto_da_alloc,commit=1,nodelalloc wait,check,formattable</span><br><span class="line">/dev/block/by-name/nvdata /nvdata ext4 noatime,nosuid,nodev,noauto_da_alloc,commit=1,nodelalloc wait,check,formattable</span><br><span class="line">/dev/block/by-name/nvcfg /nvcfg ext4 noatime,nosuid,nodev,noauto_da_alloc,commit=1,nodelalloc wait,check,formattable</span><br><span class="line">/dev/block/by-name/persist /persist ext4 noatime,nosuid,nodev,noauto_da_alloc,commit=1,nodelalloc wait,check,formattable</span><br><span class="line">/devices/platform/soc/11240000.mmc* auto auto defaults voldmanaged=sdcard1:auto,encryptable=userdata</span><br><span class="line">/devices/platform/usb_xhci* auto vfat defaults voldmanaged=usbotg:auto</span><br><span class="line">/devices/platform/soc/11201000.usb0/11200000.xhci* auto vfat defaults voldmanaged=usbotg:auto</span><br><span class="line">/dev/block/by-name/frp /persistent emmc defaults defaults</span><br><span class="line">/dev/block/by-name/nvram /nvram emmc defaults defaults</span><br><span class="line">/dev/block/by-name/proinfo /proinfo emmc defaults defaults</span><br><span class="line">/dev/block/by-name/lk /bootloader emmc defaults defaults</span><br><span class="line">/dev/block/by-name/lk2 /bootloader2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/para /para emmc defaults defaults</span><br><span class="line">/dev/block/by-name/misc /misc emmc defaults defaults</span><br><span class="line">/dev/block/by-name/boot /boot emmc defaults first_stage_mount,nofail,slotselect</span><br><span class="line">/dev/block/by-name/vbmeta_vendor /vbmeta_vendor emmc defaults first_stage_mount,nofail,slotselect</span><br><span class="line">/dev/block/by-name/vbmeta_system /vbmeta_system emmc defaults first_stage_mount,nofail,slotselect,avb=vbmeta</span><br><span class="line">/dev/block/by-name/logo /logo emmc defaults defaults</span><br><span class="line">/dev/block/by-name/expdb /expdb emmc defaults defaults</span><br><span class="line">/dev/block/by-name/seccfg /seccfg emmc defaults defaults</span><br><span class="line">/dev/block/by-name/tee1 /tee1 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/tee2 /tee2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/scp1 /scp1 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/scp2 /scp2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/sspm_1 /sspm_1 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/sspm_2 /sspm_2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/dpm_1 /dpm_1 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/dpm_2 /dpm_2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/mcupm_1 /mcupm_1 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/mcupm_2 /mcupm_2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/md1img /md1img emmc defaults defaults</span><br><span class="line">/dev/block/by-name/md1dsp /md1dsp emmc defaults defaults</span><br><span class="line">/dev/block/by-name/md1arm7 /md1arm7 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/md3img /md3img emmc defaults defaults</span><br><span class="line">/dev/block/by-name/gz1 /gz1 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/gz2 /gz2 emmc defaults defaults</span><br><span class="line">/dev/block/by-name/spmfw /spmfw emmc defaults defaults</span><br><span class="line">/dev/block/by-name/audio_dsp /audio_dsp emmc defaults defaults</span><br><span class="line">/dev/block/by-name/pi_img /pi_img emmc defaults defaults</span><br><span class="line">/dev/block/by-name/boot_para /boot_para emmc defaults defaults</span><br><span class="line">/dev/block/by-name/odmdtbo /odmdtbo emmc defaults defaults</span><br><span class="line">/dev/block/by-name/dtbo /dtbo emmc defaults defaults</span><br><span class="line">/dev/block/by-name/otp /otp emmc defaults defaults</span><br><span class="line">/dev/block/by-name/vbmeta /vbmeta emmc defaults defaults</span><br></pre></td></tr></table></figure>

<p>让我们编译试一下，值得注意的是，twrp 每次更改最好删除 out 重新编译，不要使用如<code>make installclean</code>等命令，可能会开机黑屏或更改不生效。<br>经过一分钟，编译好了，刷入，开机，启动！可以看见挂载成功被修好。</p>
<h5 id="修复屏幕显示"><a href="#修复屏幕显示" class="headerlink" title="修复屏幕显示"></a>修复屏幕显示</h5><p>可以看到我们现在屏幕的顶部的时间被摄像头挖孔挡住了。我们使用两个偏移 Flag 来修复它。<br>在 BoardConfig.mk 中，加入以下 flag</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TW_Y_OFFSET := 106 <span class="comment">#导航栏向上</span></span><br><span class="line">TW_H_OFFSET := -106 <span class="comment">#界面整体向下</span></span><br></pre></td></tr></table></figure>

<h5 id="修复振动"><a href="#修复振动" class="headerlink" title="修复振动"></a>修复振动</h5><blockquote>
<p>仅供参考，研究半天发现只有解密功能正常才能修振动，不然会冻屏！！！<br>不一定正确，也不一定普遍，仅供指路</p>
</blockquote>
<p>老设备一般都是正常的，不需要额外处理，新设备使用 aidl hal 需要我们自己处理一下让 service 正常工作。<br>挂载 vendor，使用 twrp 的文件管理，在 vendor&#x2F;etc&#x2F;vintf&#x2F;manifest 找到含有 vibrator 字样的文件。打开之后检查是否类似这样的文段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;manifest version=&quot;1.0&quot; type=&quot;device&quot;&gt;</span><br><span class="line">    &lt;hal format=&quot;aidl&quot; override=&quot;true&quot;&gt;</span><br><span class="line">        &lt;name&gt;android.hardware.vibrator&lt;/name&gt;</span><br><span class="line">        &lt;fqname&gt;IVibrator/vibratorfeature&lt;/fqname&gt;</span><br><span class="line">    &lt;/hal&gt;</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure>

<p>那恭喜你，找对了，我的文件名是<br><code>vendor.xiaomi.hardware.vibratorfeature.service.xml</code><br>将它使用<code>adb pull</code>放到电脑上自己方便的位置备用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/$/mjw  adb pull /vendor/etc/vintf/manifest/vendor.xiaomi.hardware.vibratorfeature.service.xml .</span><br><span class="line">/vendor/etc/vintf/manifest/vendor.xiao...ipped. 0.2 MB/s (1718 bytes in 0.009s)</span><br></pre></td></tr></table></figure>

<p>不看扩展名，到 vendor&#x2F;bin&#x2F;hw&#x2F;找到同名的 service 同样利用<code>adb pull</code>放电脑备用。比如我的叫<br><code>vendor.xiaomi.hardware.vibratorfeature.service</code><br>然后到 vendor&#x2F;etc&#x2F;init&#x2F;找到同名.rc 文件，拉到电脑上，在里面加一条。并在定义 service 的最下面加上<code>seclabel u:r:recovery:s0</code>可以被 recovery 使用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">on boot</span><br><span class="line">    start service被定义的名字</span><br></pre></td></tr></table></figure>

<p>例如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">on post-fs-data</span><br><span class="line">    chown system system /sys/bus/i2c/drivers/aw8697_haptic/2-005a/f0_save</span><br><span class="line">    chown system system /sys/bus/i2c/drivers/aw8697_haptic/2-005a/osc_save</span><br><span class="line">    chown system system /sys/bus/i2c/drivers/aw8697_haptic/3-005a/osc_save</span><br><span class="line">    # 省略一万字</span><br><span class="line"></span><br><span class="line">on boot</span><br><span class="line">    start vibratorfeature-hal-service</span><br><span class="line"></span><br><span class="line">service vibratorfeature-hal-service /vendor/bin/hw/vendor.xiaomi.hardware.vibratorfeature.service</span><br><span class="line">    class hal</span><br><span class="line">    user system</span><br><span class="line">    group system input</span><br><span class="line">    onrestart restart vibratorfeature</span><br><span class="line">    seclabel u:r:recovery:s0</span><br></pre></td></tr></table></figure>

<p>此外这种新设备在内核里还有振动模块需要加载，请到&#x2F;vendor&#x2F;modules&#x2F;1.1&#x2F;中寻找，例如我这台设备是<code>haptic.ko</code>，用 adb pull 拉取到电脑上，然后</p>
<ul>
<li>haptic.ko –&gt; recovery&#x2F;root&#x2F;vendor&#x2F;modules&#x2F;1.1</li>
</ul>
<p>至此所有必要的资料就准备好了。可能开机后仍然不工作，需要抓取 log 补缺失的 library，当然这是后话了。</p>
<p>开干！</p>
<p>在 BoardConfig.mk 中加入以下 flag</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TW_SUPPORT_INPUT_AIDL_HAPTICS := true</span><br></pre></td></tr></table></figure>

<p>将备用文件按照以下操作复制</p>
<ul>
<li><p>vendor.xiaomi.hardware.vibratorfeature.service.xml –&gt; recovery&#x2F;root&#x2F;vendor&#x2F;etc&#x2F;vintf&#x2F;manifest</p>
</li>
<li><p>vendor.xiaomi.hardware.vibratorfeature.service –&gt; recovery&#x2F;root&#x2F;vendor&#x2F;bin&#x2F;hw</p>
</li>
<li><p>vendor.xiaomi.hardware.vibratorfeature.service.rc –&gt; recovery&#x2F;root&#x2F;vendor&#x2F;etc&#x2F;init</p>
</li>
</ul>
<p>之后编译，刷入，开机，喜提冻屏……<br>问题不大，使用<code>adb logcat</code>抓取日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb logcat &gt; log.log</span><br></pre></td></tr></table></figure>

<p>打开 log，搜索<code>F linker</code>、<code>linker</code>、<code>library</code>、<code>beginning of crash</code>这几个关键词，我搜索第一个就出来了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F linker  : CANNOT LINK EXECUTABLE &quot;/vendor/bin/hw/vendor.xiaomi.hardware.vibratorfeature.service&quot;: library &quot;android.hardware.vibrator-V1-ndk_platform.so&quot; not found: needed by main executable</span><br></pre></td></tr></table></figure>

<p>这段报错的意思就是<code>vendor.xiaomi.hardware.vibratorfeature.service</code>找不到<code>android.hardware.vibrator-V1-ndk_platform.so</code>这个库，所以无法正常工作。</p>
<p>打开 BoardConfig.mk 加入以下 flag</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Library</span></span><br><span class="line">TARGET_RECOVERY_DEVICE_MODULES += \</span><br><span class="line">    android.hardware.vibrator-V1-ndk_platform.vendor</span><br><span class="line"></span><br><span class="line">TW_RECOVERY_ADDITIONAL_RELINK_LIBRARY_FILES += \</span><br><span class="line">    <span class="variable">$(TARGET_OUT_SHARED_LIBRARIES)</span>/android.hardware.vibrator-V1-ndk_platform.so</span><br></pre></td></tr></table></figure>

<p>再次编译尝试<br>开机之后依然冻屏，继续抓 log，查找</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F linker  : CANNOT LINK EXECUTABLE &quot;/vendor/bin/hw/vendor.xiaomi.hardware.vibratorfeature.service&quot;: library &quot;vendor.hardware.vibratorfeature.IVibratorExt-V1-ndk_platform.so&quot; not found: needed by main executable</span><br></pre></td></tr></table></figure>

<p><code>vendor.hardware.vibratorfeature</code>字样和我们之前导入的文件长得差不多，一般都是供应商专有文件，所以去设备提取，路径在 vendor&#x2F;lib64 里，虽然设备冻屏了，但我们可以用<code>adb pull</code>直接拉取到电脑。就像这样。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/$/mjw  adb shell mount /vendor</span><br><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/$/mjw  adb pull /vendor/lib64/vendor.hardware.vibratorfeature.IVibratorExt-V1-ndk_platform.so .</span><br><span class="line">/vendor/lib64/vendor.hardware.vibratorfeature.IVi...led, 0 skipped. 14.7 MB/s (33552 bytes in 0.002s</span><br></pre></td></tr></table></figure>

<p>将这个文件按照以下提示操作</p>
<ul>
<li>vendor.hardware.vibratorfeature.IVibratorExt-V1-ndk_platform.so –&gt; recovery&#x2F;root&#x2F;vendor&#x2F;lib64</li>
</ul>
<p>继续编译测试<br>还是冻屏，继续抓 log</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F linker  : CANNOT LINK EXECUTABLE &quot;/vendor/bin/hw/vendor.xiaomi.hardware.vibratorfeature.service&quot;: library &quot;libtinyalsa.so&quot; not found: needed by main executable</span><br></pre></td></tr></table></figure>

<p>这个 library twrp 的源码中应该没有，去设备拿一个 prebuilt 吧</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/$/mjw  adb shell mount /system_root</span><br><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/$/mjw  adb pull /system_root/system/lib64/libtinyalsa.so .</span><br><span class="line">/system_root/system/lib64/libtinyalsa.so: 1 file ...led, 0 skipped. 13.6 MB/s (45032 bytes in 0.003s</span><br></pre></td></tr></table></figure>

<p>将这个文件按照以下提示操作</p>
<ul>
<li>libtinyalsa.so –&gt; recovery&#x2F;root&#x2F;system&#x2F;lib64</li>
</ul>
<p>编译测试<br>我艹了，还是冻屏，这次搜那几个关键词都搜不到了，搜<code>vibrator</code>看看这鬼东西报什么</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E vendor.xiaomi.hardware.vibratorfeature.service: fail to load lib : /vendor/lib64/libaachaptics.so</span><br></pre></td></tr></table></figure>

<p>这次都直接给路径了，直接拿。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/$/mjw  adb shell mount /vendor</span><br><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~/github/$/mjw  adb pull /vendor/lib64/libaachaptics.so .</span><br><span class="line">/vendor/lib64/libaachaptics.so: 1 file pulled, 0 skipped. 15.8 MB/s (56232 bytes in 0.003s)</span><br></pre></td></tr></table></figure>

<p>将这个文件按照以下提示操作</p>
<ul>
<li>libaachaptics.so –&gt; recovery&#x2F;root&#x2F;vendor&#x2F;lib64</li>
</ul>
<p>至此应该没什么问题了，但是有个 flag 貌似要操作 data 内的东西，未解密会导致冻屏，所以等修完解密后再来修振动。</p>
<h4 id="修复-CPU-温度"><a href="#修复-CPU-温度" class="headerlink" title="修复 CPU 温度"></a>修复 CPU 温度</h4><p>使用<code>adb shell</code> + <code>grep</code>命令在手机节点里搜索 type 关键词。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~  adb shell &#x27;grep &quot;cp_master&quot; /sys/class/thermal/*/type&#x27;</span><br><span class="line">/sys/class/thermal/thermal_zone54/type:cp_master</span><br><span class="line">xiaolegun@xiaoleGundeMac-Pro  ~  adb shell &#x27;grep &quot;cpu&quot; /sys/class/thermal/*/type&#x27;</span><br><span class="line">/sys/class/thermal/thermal_zone1/type:cpu_little1</span><br><span class="line">/sys/class/thermal/thermal_zone10/type:cpu_bigbig1</span><br><span class="line">/sys/class/thermal/thermal_zone11/type:cpu_big6</span><br><span class="line">/sys/class/thermal/thermal_zone12/type:cpu_bigbig2</span><br><span class="line">/sys/class/thermal/thermal_zone2/type:cpu_little2</span><br><span class="line">/sys/class/thermal/thermal_zone3/type:cpu_little3</span><br><span class="line">/sys/class/thermal/thermal_zone4/type:cpu_little4</span><br><span class="line">/sys/class/thermal/thermal_zone5/type:cpu_big1</span><br><span class="line">/sys/class/thermal/thermal_zone6/type:cpu_big2</span><br><span class="line">/sys/class/thermal/thermal_zone7/type:cpu_big3</span><br><span class="line">/sys/class/thermal/thermal_zone8/type:cpu_big4</span><br><span class="line">/sys/class/thermal/thermal_zone9/type:cpu_big5</span><br></pre></td></tr></table></figure>

<p>我这里选用<code>cp_master</code>节点来读取温度。我的节点路径为<code>/sys/class/thermal/thermal_zone54</code>在后面添加 temp 来读取温度，你可以使用<code>cat</code>来检测节点是否可以正常读取温度</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell &#x27;cat /sys/class/thermal/thermal_zone54/temp&#x27;</span><br></pre></td></tr></table></figure>

<p>如果返回如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">28000</span><br></pre></td></tr></table></figure>

<p>这种类似的数值，那多半是没有问题的。<br>我们在 BoardConfig.mk 中加入</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TW_CUSTOM_CPU_TEMP_PATH := <span class="string">&quot;/sys/class/thermal/thermal_zone54/temp&quot;</span></span><br></pre></td></tr></table></figure>

<p>至此 cpu 温度就修复好了。</p>
<h2 id="后序"><a href="#后序" class="headerlink" title="后序"></a>后序</h2><p>这是我玩 Android 两年内第一次写关于 Android 的文章，内容和措辞可能不是很准确，再加上开学焦虑，租房因租金和房源不顺利，写的很乱，请各位指正。<br>解密等有空补，先补作业。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://source.android.com/docs/setup/create/new-device?hl=zh-cn">Google - 添加新设备</a></p>
<p><a target="_blank" rel="noopener" href="https://source.android.com/docs/core/ota/ab?hl=zh-cn">Google - A&#x2F;B（无缝）系统更新</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.lynnrin.moe/posts/ROM-bringup-guide-prebuilt/#boardconfigmk">Lynnrin - 快速上手 Android Custom ROM 适配 - Prebuilt Vendor</a></p>
<p><a target="_blank" rel="noopener" href="https://source.android.com/docs/core/architecture/vintf?hl=zh-cn">Google - 供应商接口对象</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>为新设备编写Recovery device tree</p><p><a href="https://blog.xiaolegun.cn/post/writing-recovery-device-tree-for-new-device/">https://blog.xiaolegun.cn/post/writing-recovery-device-tree-for-new-device/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>xiaoleGun</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-02-20</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-02-20</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Android/">Android</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/post/Fuck-Huawei/"><span class="level-item">华为搞机指北(小白向)</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn.jsdelivr.net/npm/leancloud-storage@3/dist/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.16/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread',
            appId: "Ou1qvpQXJbkoS36f8u6xjWiF-gzGzoHsz",
            appKey: "t4FiwzvUxbTTNwx7dQpiHE3d",
            
            avatar: "retro",
            avatarForce: false,
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "zh-CN",
            visitor: false,
            highlight: true,
            recordIP: true,
            
            
            
            enableQQ: true,
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/touxiang.png" alt="xiaoleGun"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">xiaoleGun</p><p class="is-size-6 is-block">“尊严只在剑峰之上，真理只在大炮射程之中”</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Beijing, P.R.C.</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">3</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/xiaoleGun" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/xiaoleGun"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/xiaoleGun"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-20T02:46:55.000Z">2024-02-20</time></p><p class="title"><a href="/post/writing-recovery-device-tree-for-new-device/">为新设备编写Recovery device tree</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-02-19T12:37:55.000Z">2022-02-19</time></p><p class="title"><a href="/post/Fuck-Huawei/">华为搞机指北(小白向)</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-15T13:37:55.000Z">2022-01-15</time></p><p class="title"><a href="/post/Project-Mushroom/">Project-Mushroom</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">二月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GSI/"><span class="tag">GSI</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ROM/"><span class="tag">ROM</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/touxiang.png" alt="xiaoleGun&#039;Blog" height="28"></a><p class="is-size-7"><span>&copy;&nbsp;2020 - 2024 xiaoleGun</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>